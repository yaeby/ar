<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AR Interaction Lab (No Super-Hands)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame (Image Tracking) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family: 'Courier New', Courier, monospace; }
    
    /* --- HUD (Bottom) --- */
    .hud {
      position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%);
      display: grid; grid-template-columns: repeat(5, auto); gap: 8px;
      z-index: 10; pointer-events: none;
    }
    .hud.hidden { display: none; }
    .hud button {
      pointer-events: auto;
      padding: 10px 12px; border: 2px solid #4a3b2a; border-radius: 8px;
      background: #d4b483; color: #4a3b2a; font-weight: bold;
      box-shadow: 2px 2px 0px #4a3b2a;
    }
    .hud button:active { transform: translate(2px, 2px); box-shadow: none; }

    /* --- Story Overlay (Center) --- */
    .story-overlay {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 80%; max-width: 400px;
      background: url('https://www.transparenttextures.com/patterns/aged-paper.png'), #f4e4bc;
      border: 4px solid #5c4033; border-radius: 10px;
      padding: 20px; text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 20; display: none;
    }
    .story-overlay.visible { display: block; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .story-overlay h2 { margin-top: 0; color: #8b0000; text-transform: uppercase; letter-spacing: 2px; }
    .story-overlay p { font-size: 1.1em; line-height: 1.4; color: #3e2723; }
    .story-overlay button {
      margin-top: 15px; padding: 10px 20px;
      background: #8b0000; color: #fff; border: none; border-radius: 5px;
      font-size: 1em; cursor: pointer;
    }
    @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

    /* --- Level Indicator (Top) --- */
    .level-bar {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 15px; z-index: 10;
      background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px;
    }
    .level-dot {
      width: 40px; height: 40px; border-radius: 50%;
      background: #555; border: 2px solid #888;
      display: flex; justify-content: center; align-items: center;
      font-size: 20px; color: #aaa; opacity: 0.5;
      transition: all 0.3s ease;
    }
    .level-dot.active {
      background: #d4b483; border-color: #8b0000;
      color: #8b0000; opacity: 1; transform: scale(1.2);
      box-shadow: 0 0 15px #d4b483;
    }
    .level-dot.completed {
      background: #4caf50; border-color: #2e7d32;
      color: white; opacity: 1;
    }

    /* Loader for NFT */
    .arjs-loader {
      height: 100%; width: 100%; position: absolute; top: 0; left: 0;
      background-color: rgba(0, 0, 0, 0.8); z-index: 9999;
      display: flex; justify-content: center; align-items: center;
    }
    .arjs-loader div { text-align: center; font-size: 1.25em; color: white; font-family: sans-serif; }
  </style>

  <script>
  // ---------- Utilities ----------
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

  // ---------- 1) Tap / doubletap / longpress ----------
  AFRAME.registerComponent('tap-gestures', {
    schema: {longMs:{default:500}},
    init () {
      let lastTap = 0, pressTimer = null, down = false;
      this.el.addEventListener('mousedown', () => {
        down = true;
        const now = performance.now();
        if (now - lastTap < 300) this.el.emit('doubletap');
        lastTap = now;
        pressTimer = setTimeout(() => { if (down) this.el.emit('longpress'); }, this.data.longMs);
      });
      this.el.addEventListener('mouseup', () => {
        down = false;
        clearTimeout(pressTimer);
        this.el.emit('tap');
      });
      this.el.addEventListener('touchstart', e => e.preventDefault(), {passive:false});
    }
  });

  // ---------- 2) Drag on a plane (marker plane) ----------
  // Drag with mouse/touch by intersecting an invisible plane and moving the entity to that point.
  AFRAME.registerComponent('drag-on-plane', {
    schema: { plane: {type: 'selector'}, yOffset: {default: 0.25}, radius: {default: 0.6} },
    init () {
      this.dragging = false;
      this.scene = this.el.sceneEl;
      this.rayEl = document.querySelector('#ray'); // scene cursor ray
      // listen on element
      this.el.addEventListener('mousedown', () => this.dragging = true);
      window.addEventListener('mouseup',   () => this.dragging = false);
      window.addEventListener('touchend',  () => this.dragging = false);
      // move
      this.scene.addEventListener('mousemove', (e)=> this.updateDrag());
      this.scene.addEventListener('touchmove', (e)=> this.updateDrag());
    },
    updateDrag () {
      if (!this.dragging) return;
      if (!this.data.plane) return;
      const raycaster = this.rayEl.getObject3D('raycaster');
      if (!raycaster) return;
      const planeMesh = this.data.plane.getObject3D('mesh');
      if (!planeMesh) return;

      // Build a THREE.Plane from the plane entity (its world transform).
      planeMesh.updateMatrixWorld();
      const normal = new THREE.Vector3(0,1,0).applyQuaternion(planeMesh.getWorldQuaternion(new THREE.Quaternion()));
      const point  = planeMesh.getWorldPosition(new THREE.Vector3());
      const plane  = new THREE.Plane().setFromNormalAndCoplanarPoint(normal, point);

      const ray = raycaster.ray; // world-space ray from cursor
      const hit = new THREE.Vector3();
      if (ray.intersectPlane(plane, hit)) {
        // constrain to radius on XZ around marker center
        const local = this.el.parentEl.object3D.worldToLocal(hit.clone());
        const r = Math.hypot(local.x, local.z);
        const maxR = this.data.radius;
        if (r > maxR){
          const k = maxR / r;
          local.x *= k; local.z *= k;
        }
        this.el.setAttribute('position', `${local.x} ${this.data.yOffset} ${local.z}`);
      }
    }
  });

  // ---------- 3) Pinch to scale ----------
  AFRAME.registerComponent('pinch-scale', {
    schema: {min:{default:0.2}, max:{default:3}},
    init(){
      this.active = false; this.startD = 0; this.startScale = null;
      const onStart = (e) => {
        if (e.touches && e.touches.length === 2){
          this.active = true;
          this.startD = this.dist(e.touches[0], e.touches[1]);
          this.startScale = Object.assign({}, this.el.getAttribute('scale'));
        }
      };
      const onMove = (e) => {
        if (!this.active || !e.touches || e.touches.length < 2) return;
        const d = this.dist(e.touches[0], e.touches[1]);
        const mult = d / this.startD;
        const ns = {
          x: clamp(this.startScale.x * mult, this.data.min, this.data.max),
          y: clamp(this.startScale.y * mult, this.data.min, this.data.max),
          z: clamp(this.startScale.z * mult, this.data.min, this.data.max),
        };
        this.el.setAttribute('scale', ns);
      };
      const onEnd = () => this.active = false;
      window.addEventListener('touchstart', onStart, {passive:false});
      window.addEventListener('touchmove',  onMove,  {passive:false});
      window.addEventListener('touchend',   onEnd);
      window.addEventListener('touchcancel',onEnd);
    },
    dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }
  });

  // ---------- 4) Twist to rotate (two-finger) ----------
  AFRAME.registerComponent('twist-rotate', {
    schema:{degPerRad:{default:57.2958}}, // 180/œÄ
    init(){
      this.active = false; this.startA = 0; this.startRotY = 0;
      const angle = (a,b)=> Math.atan2(b.clientY-a.clientY, b.clientX-a.clientX);
      const onStart = (e)=>{
        if (e.touches && e.touches.length === 2){
          this.active = true;
          this.startA = angle(e.touches[0], e.touches[1]);
          this.startRotY = this.el.getAttribute('rotation').y;
        }
      };
      const onMove = (e)=>{
        if (!this.active || !e.touches || e.touches.length < 2) return;
        const a = angle(e.touches[0], e.touches[1]);
        const delta = (a - this.startA) * this.data.degPerRad;
        const r = this.el.getAttribute('rotation');
        this.el.setAttribute('rotation', {x:r.x, y:this.startRotY + delta, z:r.z});
      };
      const onEnd = ()=> this.active = false;
      window.addEventListener('touchstart', onStart, {passive:false});
      window.addEventListener('touchmove',  onMove,  {passive:false});
      window.addEventListener('touchend',   onEnd);
      window.addEventListener('touchcancel',onEnd);
    }
  });

  // ---------- 5) Spin toggler + random color (hooked to taps) ----------
  AFRAME.registerComponent('spin-toggle', {
    schema:{speed:{default:4000}},
    init(){
      this.spinning = false;
      this.el.addEventListener('toggle-spin', ()=> {
        this.spinning = !this.spinning;
        if (this.spinning) {
          this.el.setAttribute('animation__spin',
            `property: rotation; to: 0 360 0; loop: true; dur: ${this.data.speed}`);
        } else {
          this.el.removeAttribute('animation__spin');
        }
      });
      this.el.addEventListener('random-color', ()=> {
        const colors = ['#4CC3D9','#FFC65D','#7BC8A4','#EF2D5E','#FFFFFF'];
        const c = colors[Math.floor(Math.random()*colors.length)];
        this.el.setAttribute('material','color',c);
      });
    }
  });
  </script>
</head>
<body>
  <!-- Loader -->
  <div class="arjs-loader">
    <div>Loading the Pirate World...</div>
  </div>

  <!-- DEBUG LOG -->
  <div id="debug-log" style="position: fixed; top: 60px; left: 50%; transform: translateX(-50%); color: red; background: rgba(255,255,255,0.8); padding: 5px; z-index: 10000; font-weight: bold;">
    Waiting for marker...
  </div>

  <!-- Level Bar -->
  <div class="level-bar">
    <div class="level-dot active" id="lvl-1">üó∫Ô∏è</div>
    <div class="level-dot" id="lvl-2">üçæ</div>
    <div class="level-dot" id="lvl-3">‚õµ</div>
    <div class="level-dot" id="lvl-4">ü¶à</div>
    <div class="level-dot" id="lvl-5">üî´</div>
    <div class="level-dot" id="lvl-6">üíé</div>
  </div>

  <!-- Story Overlay -->
  <div class="story-overlay" id="story-modal">
    <h2 id="story-title">Title</h2>
    <p id="story-text">Text goes here...</p>
    <button onclick="closeStory()">Aye Aye!</button>
  </div>

  <!-- HUD -->
  <div class="hud" id="hud">
    <button id="btn-rot-l">‚ü≤</button>
    <button id="btn-rot-r">‚ü≥</button>
    <button id="btn-scale--">‚àí</button>
    <button id="btn-scale-+">Ôºã</button>
  </div>

  <a-scene
    embedded
    renderer="colorManagement: true; physicallyCorrectLights: true; logarithmicDepthBuffer: true;"
    vr-mode-ui="enabled: false"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

    <!-- Cursor ray for mouse/touch (A-Frame builds a raycaster object3D for us) -->
    <a-entity id="ray" cursor="rayOrigin: mouse" raycaster="objects: .raytarget"></a-entity>

    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>

    <!-- ================================================================== -->
    <!-- MARKER 1: MAP (The Start) -->
    <!-- Logic: Always shows the Ship Bottle (Model 3) to lead you there. -->
    <!-- Unlocks: Stage 1 -->
    <!-- ================================================================== -->
    <a-nft
      type="nft"
      url="assets/markers/map"
      smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"
      id="marker-map">
      
      <!-- Reduced scale from 150 to 50 to fix "too big" -->
      <a-entity scale="50 50 50">
        <!-- Unlocked: 3_ship_in_a_bottle -->
        <!-- Adjusted rotation to -90 0 0 for standard upright -->
        <a-entity gltf-model="assets/models/3_ship_in_a_bottle/scene.gltf"
                  position="0 0 0" scale="0.01 0.01 0.01" rotation="0 90 0"
                  class="raytarget" tap-gestures spin-toggle pinch-scale twist-rotate>
        </a-entity>
      </a-entity>
    </a-nft>

    <!-- ================================================================== -->
    <!-- MARKER 2: SHIP BOTTLE -->
    <!-- Logic: Shows Ghost Ship (Model 4) IF Stage >= 1. -->
    <!-- Unlocks: Stage 2 -->
    <!-- ================================================================== -->
    <a-nft
      type="nft"
      url="assets/markers/ship_bottle"
      smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"
      id="marker-ship-bottle">
      
      <a-entity scale="50 50 50">
        <!-- LOCKED STATE: 1_pirate_map -->
        <a-entity id="ship-bottle-locked"
                  gltf-model="assets/models/1_pirate_map/scene.gltf"
                  visible="true"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0"
                  class="raytarget" tap-gestures spin-toggle pinch-scale twist-rotate>
        </a-entity>

        <!-- UNLOCKED STATE: 4_ghost_ship -->
        <!-- Adjusted rotation to -90 0 0 -->
        <a-entity id="ship-bottle-unlocked"
                  gltf-model="assets/models/4_ghost_ship/scene.gltf"
                  visible="false"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0"
                  class="raytarget" tap-gestures spin-toggle pinch-scale twist-rotate>
        </a-entity>
      </a-entity>
    </a-nft>

    <!-- ================================================================== -->
    <!-- MARKER 3: SHIP (The Attack) -->
    <!-- Logic: Shows Shark (Model 6) IF Stage >= 2. -->
    <!-- Unlocks: Stage 3 -->
    <!-- ================================================================== -->
    <a-nft
      type="nft"
      url="assets/markers/ship"
      smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"
      id="marker-ship">
      
      <a-entity scale="50 50 50">
        <!-- LOCKED -->
        <a-entity id="ship-locked"
                  gltf-model="assets/models/1_pirate_map/scene.gltf"
                  visible="true"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0">
        </a-entity>

        <!-- UNLOCKED: 6_great_white_shark -->
        <a-entity id="ship-unlocked"
                  gltf-model="assets/models/6_great_white_shark/scene.gltf"
                  visible="false"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0"
                  class="raytarget" tap-gestures spin-toggle pinch-scale twist-rotate>
        </a-entity>
      </a-entity>
    </a-nft>

    <!-- ================================================================== -->
    <!-- MARKER 4: SHARK (The Weapon) -->
    <!-- Logic: Shows Pirate Gun (Model 5.1) IF Stage >= 3. -->
    <!-- Unlocks: Stage 4 -->
    <!-- ================================================================== -->
    <a-nft
      type="nft"
      url="assets/markers/shark2"
      smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"
      id="marker-shark">
      
      <a-entity scale="50 50 50">
        <!-- LOCKED -->
        <a-entity id="shark-locked"
                  gltf-model="assets/models/1_pirate_map/scene.gltf"
                  visible="true"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0">
        </a-entity>

        <!-- UNLOCKED: 5.1_pirate_gun -->
        <a-entity id="shark-unlocked"
                  gltf-model="assets/models/5.1_pirate_gun/scene.gltf"
                  visible="false"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0"
                  class="raytarget" tap-gestures spin-toggle pinch-scale twist-rotate>
        </a-entity>
      </a-entity>
    </a-nft>

    <!-- ================================================================== -->
    <!-- MARKER 5: CHEST (The Treasure) -->
    <!-- Logic: Shows Treasure (Model 8). -->
    <!-- Unlocks: Stage 5 (End) -->
    <!-- FAIL CONDITION: If scanned before Shark (Stage 3), YOU DIE. -->
    <!-- ================================================================== -->
    <a-nft
      type="nft"
      url="assets/markers/chest"
      smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"
      id="marker-chest">
      
      <a-entity scale="50 50 50">
        <!-- LOCKED -->
        <a-entity id="chest-locked"
                  gltf-model="assets/models/1_pirate_map/scene.gltf"
                  visible="true"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0">
        </a-entity>

        <!-- UNLOCKED: 8_medieval_chest -->
        <a-entity id="chest-unlocked"
                  gltf-model="assets/models/8_medieval_chest/scene.gltf"
                  visible="false"
                  position="0 0 0" scale="1 1 1" rotation="-90 0 0"
                  class="raytarget" tap-gestures spin-toggle pinch-scale twist-rotate>
        </a-entity>
      </a-entity>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const hud  = document.getElementById('hud');
    
    // --- Game State ---
    let currentStage = 0; 
    // 0 = Start (Find Map)
    // 1 = Map Found (Find Ship Bottle)
    // 2 = Ship Bottle Found (Find Ship)
    // 3 = Ship Found (Find Shark)
    // 4 = Shark Found (Find Chest)
    // 5 = Chest Found (Win)

    // --- Elements ---
    const m_map    = document.getElementById('marker-map');
    const m_ship_bottle = document.getElementById('marker-ship-bottle');
    const m_ship   = document.getElementById('marker-ship');
    const m_shark  = document.getElementById('marker-shark');
    const m_chest  = document.getElementById('marker-chest');

    const ship_bottle_locked = document.getElementById('ship-bottle-locked');
    const ship_bottle_unlocked = document.getElementById('ship-bottle-unlocked');
    const ship_locked     = document.getElementById('ship-locked');
    const ship_unlocked   = document.getElementById('ship-unlocked');
    const shark_locked    = document.getElementById('shark-locked');
    const shark_unlocked  = document.getElementById('shark-unlocked');
    const chest_locked    = document.getElementById('chest-locked');
    const chest_unlocked  = document.getElementById('chest-unlocked');

    // --- DEBUG LOGGING ---
    const debugEl = document.getElementById('debug-log');
    function log(msg) { if(debugEl) debugEl.innerText = msg; console.log(msg); }
    
    [m_map, m_ship_bottle, m_ship, m_shark, m_chest].forEach(m => {
       if(!m) return;
       m.addEventListener('markerFound', () => log("Found: " + m.id));
       m.addEventListener('markerLost',  () => log("Lost: " + m.id));
    });

    // --- Logic ---
    
    // 1. Found MAP -> Unlock Stage 1
    m_map.addEventListener('markerFound', () => {
      if (currentStage < 1) {
        currentStage = 1;
        updateVisibility();
        showStory("The Adventure Begins!", "Arrr! Ye found the map! Now find the Ship in a Bottle!");
      }
    });

    // 2. Found SHIP BOTTLE -> Unlock Stage 2
    m_ship_bottle.addEventListener('markerFound', () => {
      if (currentStage >= 1) {
        if (currentStage < 2) {
          currentStage = 2;
          updateVisibility();
          showStory("Ghost Ship Found!", "Ye found the Ghost Ship! Now find the real Ship!");
        }
      } else {
        showStory("Locked!", "Ye need to find the Map first!");
      }
    });

    // 3. Found SHIP -> Unlock Stage 3
    m_ship.addEventListener('markerFound', () => {
      if (currentStage >= 2) {
        if (currentStage < 3) {
          currentStage = 3;
          updateVisibility();
          showStory("Shark Attack!", "Beware! A shark is near! Find the Shark marker!");
        }
      } else {
        showStory("Locked!", "Find the Ship in a Bottle first!");
      }
    });

    // 4. Found SHARK -> Unlock Stage 4
    m_shark.addEventListener('markerFound', () => {
      if (currentStage >= 3) {
        if (currentStage < 4) {
          currentStage = 4;
          updateVisibility();
          showStory("Weapon Found!", "Ye defeated the shark and found a gun! Now find the Treasure Chest!");
        }
      } else {
        showStory("Locked!", "Find the Ship first!");
      }
    });

    // 5. Found CHEST -> Unlock Stage 5 (Win) OR Game Over
    m_chest.addEventListener('markerFound', () => {
      if (currentStage >= 4) {
        // Win Condition
        if (currentStage < 5) {
          currentStage = 5;
          updateVisibility();
          showStory("TREASURE!", "Congratulations! Ye found the lost treasure of the Seven Seas!");
        }
      } else if (currentStage === 3) {
        // Game Over Condition: Skipped Shark
        showStory("GAME OVER", "You tried to get the treasure but got eaten by the shark! You died.");
      } else {
        showStory("Locked!", "Ye must find the Shark first!");
      }
    });


    function updateVisibility() {
      // Update Level Bar
      const dots = document.querySelectorAll('.level-dot');
      // Stage 0: Start (No dots done)
      // Stage 1: Map Found (Dot 1 Done, Dot 2 Active)
      // Stage 2: Bottle Found (Dot 2 Done, Dot 3 Active)
      // Stage 3: Ship Found (Dot 3 Done, Dot 4 Active)
      // Stage 4: Shark Found (Dot 4 Done, Dot 5 Active)
      // Stage 5: Chest Found (All Done)

      if(dots.length > 0) dots[0].className = currentStage >= 1 ? 'level-dot completed' : 'level-dot active';
      if(dots.length > 1) dots[1].className = currentStage >= 2 ? 'level-dot completed' : (currentStage === 1 ? 'level-dot active' : 'level-dot');
      if(dots.length > 2) dots[2].className = currentStage >= 3 ? 'level-dot completed' : (currentStage === 2 ? 'level-dot active' : 'level-dot');
      if(dots.length > 3) dots[3].className = currentStage >= 4 ? 'level-dot completed' : (currentStage === 3 ? 'level-dot active' : 'level-dot');
      if(dots.length > 4) dots[4].className = currentStage >= 5 ? 'level-dot completed' : (currentStage === 4 ? 'level-dot active' : 'level-dot');
      if(dots.length > 5) dots[5].className = currentStage >= 5 ? 'level-dot completed' : (currentStage === 5 ? 'level-dot active' : 'level-dot');

      // Helper to toggle locked/unlocked models
      const toggle = (idLocked, idUnlocked, unlocked) => {
         const l = document.getElementById(idLocked);
         const u = document.getElementById(idUnlocked);
         if(l && u) {
            l.setAttribute('visible', !unlocked);
            u.setAttribute('visible', unlocked);
         }
      };

      toggle('ship-bottle-locked', 'ship-bottle-unlocked', currentStage >= 1);
      toggle('ship-locked', 'ship-unlocked', currentStage >= 2);
      toggle('shark-locked', 'shark-unlocked', currentStage >= 3);
      toggle('chest-locked', 'chest-unlocked', currentStage >= 4);
    }

    // --- Story Modal Logic ---
    const modal = document.getElementById('story-modal');
    const titleEl = document.getElementById('story-title');
    const textEl = document.getElementById('story-text');

    function showStory(title, text) {
      titleEl.innerText = title;
      textEl.innerText = text;
      modal.classList.add('visible');
    }

    window.closeStory = function() {
      modal.classList.remove('visible');
    }

    // Initialize
    updateVisibility();


    // Buttons (Generic rotation helper for whatever is visible)
    // Note: This simple logic rotates ALL models. In a real app you'd target the visible one.
    document.getElementById('btn-rot-l').addEventListener('click', () => nudgeRot(-15));
    document.getElementById('btn-rot-r').addEventListener('click', () => nudgeRot( 15));
    
    function nudgeRot(delta){
      const models = document.querySelectorAll('a-entity[gltf-model]');
      models.forEach(el => {
        if(el.getAttribute('visible') !== false) {
           const r = el.getAttribute('rotation');
           el.setAttribute('rotation', {x:r.x, y:r.y + delta, z:r.z});
        }
      });
    }

    document.getElementById('btn-scale--').addEventListener('click', () => nudgeScale(0.9));
    document.getElementById('btn-scale-+').addEventListener('click', () => nudgeScale(1.1));
    function nudgeScale(mult){
      const models = document.querySelectorAll('a-entity[gltf-model]');
      models.forEach(el => {
        if(el.getAttribute('visible') !== false) {
           const s = el.getAttribute('scale');
           el.setAttribute('scale', {
             x: clamp(s.x * mult, 0.1, 10),
             y: clamp(s.y * mult, 0.1, 10),
             z: clamp(s.z * mult, 0.1, 10)
           });
        }
      });
    }
  </script>
</body>
</html>
